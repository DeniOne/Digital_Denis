# Руководство по созданию изолированных контуров для тестирования

Этот документ описывает архитектуру и процесс запуска полностью независимых экземпляров проекта Digital Denis на одном сервере. Это необходимо для того, чтобы несколько тестировщиков могли работать одновременно, не мешая друг другу.

## Архитектура изоляции

Для изоляции используется механизм **Docker Compose Project Name** (`COMPOSE_PROJECT_NAME`).

### 1. Разделение данных
Каждый проект запускается с уникальным префиксом. Например:
- `docker-compose -p tester1 up -d`
- `docker-compose -p tester2 up -d`

Docker автоматически создаст изолированные сети и тома (volumes) для БД, используя имя проекта как префикс (`tester1_postgres_data`, `tester2_postgres_data`). Данные будут полностью разделены.

### 2. Разделение портов
Каждый контур должен слушать свои внешние порты на хосте. 

| Контур | API Port | Frontend Port | Redis Port |
| :--- | :--- | :--- | :--- |
| **Default** | 8000 | 3000 | 6379 |
| **Tester 1** | 8001 | 3001 | 6381 |
| **Tester 2** | 8002 | 3002 | 6382 |

Для реализации этого `docker-compose.yml` будет модифицирован для использования переменных:
```yaml
ports:
  - "${API_PORT:-8000}:8000"
```

### 3. Изоляция Telegram-ботов
**Критически важно:** каждый контур должен иметь свой собственный `TELEGRAM_BOT_TOKEN`.
- Нельзя использовать один токен в двух инстансах одновременно (один будет отключать другой).
- Тестировщику нужно создать своего бота через [@BotFather](https://t.me/BotFather) и получить токен.

## Инструкция по запуску нового контура

1.  **Подготовьте .env файл**:
    Создайте копию `.env` для нового пользователя: `cp .env .env.tester1`.
    
2.  **Настройте переменные**:
    В файле `.env.tester1` измените:
    - `API_PORT=8001`
    - `FRONTEND_PORT=3001`
    - `TELEGRAM_BOT_TOKEN=новый_токен`
    - `DATABASE_URL` (пароль и имя БД могут остаться прежними внутри контейнера, так как тома разделены префиксом проекта).

3.  **Запустите контур**:
    ```bash
    docker-compose -p tester1 --env-file .env.tester1 up -d
    ```

## Управление контурами

- **Просмотр статуса**: `docker-compose -p tester1 ps`
- **Просмотр логов**: `docker-compose -p tester1 logs -f backend`
- **Остановка**: `docker-compose -p tester1 down`

> [!TIP]
> В будущем мы автоматизируем этот процесс с помощью скрипта `scripts/deploy_instance.ps1`, который будет сам назначать порты и генерировать файлы конфигурации.
