# 📐 TASK 0.1 — Architecture Overview

**Проект:** Digital Denis  
**Статус:** ✅ Завершено  
**Приоритет:** Критический  
**Зависимости:** Нет

---

## 📋 Чеклист реализации

- [x] Создать ASCII-схему в коде (comments/docs)
- [x] Все слои соответствуют схеме
- [x] Потоки данных верифицированы
- [x] Точки принятия решений реализованы
- [ ] Документ обновлён после изменений

---

## 🎯 Цель

Сформировать итоговую архитектурную схему Digital Denis, строго следуя ADR v1.2.
Показать все слои, потоки данных и точки принятия решений.

---

## 📦 Артефакты

### 1. Architecture Overview — Высокоуровневая схема

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           DIGITAL DENIS ARCHITECTURE                        │
│                     Personal Cognitive Operating System                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            INTERFACE LAYER                                   │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐      │
│  │   Telegram Bot   │    │     Web UI       │    │   Future APIs    │      │
│  │  (Dialog Input)  │    │ (Control Plane)  │    │   (Extensible)   │      │
│  └────────┬─────────┘    └────────┬─────────┘    └────────┬─────────┘      │
└───────────┼──────────────────────┼──────────────────────┼───────────────────┘
            │                      │                      │
            └──────────────────────┼──────────────────────┘
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           BACKEND ORCHESTRATOR                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Request Router                                │   │
│  │  • Классификация запроса (strategic/analytical/operational/reflexive)│   │
│  │  • Выбор агента                                                      │   │
│  │  • Управление контекстом                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Digital Profile Engine                          │   │
│  │  • Стиль мышления пользователя                                       │   │
│  │  • Принципы и ограничения                                            │   │
│  │  • Терминология                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Context Manager                                 │   │
│  │  • Сборка контекста для агента                                       │   │
│  │  • Извлечение релевантной памяти                                     │   │
│  │  • Управление сессией                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AGENT LAYER                                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │    CORE     │ │   ANALYST   │ │  OPERATOR   │ │   MEMORY    │           │
│  │   AGENT     │ │    AGENT    │ │    AGENT    │ │    AGENT    │           │
│  │             │ │             │ │             │ │             │           │
│  │ Мыслительный│ │ Анализ      │ │ Превращение │ │ Управление  │           │
│  │ партнёр     │ │ цифр/логики │ │ идей→действия│ │ памятью     │           │
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘           │
│         │               │               │               │                   │
│         └───────────────┴───────────────┴───────────────┘                   │
│                                     │                                        │
│  ┌──────────────────────────────────┴──────────────────────────────────┐   │
│  │                       META-ANALYST AGENT                             │   │
│  │  • Работает асинхронно (не в диалоге)                                │   │
│  │  • Анализирует паттерны мышления                                     │   │
│  │  • Генерирует отчёты и аномалии                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             MEMORY LAYER                                     │
│  ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐         │
│  │   SHORT-TERM      │ │    LONG-TERM      │ │     SEMANTIC      │         │
│  │     MEMORY        │ │     MEMORY        │ │      MEMORY       │         │
│  │                   │ │                   │ │                   │         │
│  │  Redis            │ │  PostgreSQL       │ │  FAISS/Weaviate   │         │
│  │  • Текущая сессия │ │  • Решения        │ │  • Embeddings     │         │
│  │  • Контекст       │ │  • Факты          │ │  • Semantic search│         │
│  │  • TTL: минуты    │ │  • Инсайты        │ │                   │         │
│  └───────────────────┘ └───────────────────┘ └───────────────────┘         │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COGNITIVE ANALYTICS LAYER (CAL)                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  TOPIC INTELLIGENCE  │  MIND MAPS  │  LOGIC ANALYSIS  │  ANOMALIES  │   │
│  │  ─────────────────   │  ─────────  │  ──────────────  │  ─────────  │   │
│  │  • Иерархия тем      │  • Граф     │  • Decision      │  • Baseline │   │
│  │  • Классификация     │    идей     │    Schema        │  • Deviations│  │
│  │  • Тренды            │  • Связи    │  • Риски         │  • Alerts   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                          Асинхронная обработка (Celery/RQ)                  │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LLM PROVIDERS                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   Claude Opus   │  │     GPT-4       │  │   Local LLM     │             │
│  │   (Primary)     │  │   (Fallback)    │  │   (Optional)    │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
│  ⚠️ LLM = ИСПОЛНИТЕЛЬ, а не центр принятия решений                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2. Описание слоёв

| Слой | Ответственность | Ключевые компоненты |
|------|-----------------|---------------------|
| **Interface Layer** | Точки входа пользователя | Telegram Bot, Web UI |
| **Backend Orchestrator** | Центр принятия решений | Request Router, Digital Profile, Context Manager |
| **Agent Layer** | Специализированные когнитивные операции | Core, Analyst, Operator, Memory, Meta-Analyst |
| **Memory Layer** | Хранение и доступ к памяти | Redis, PostgreSQL, Vector DB |
| **CAL** | Мета-анализ мышления | Topics, Graphs, Logic, Anomalies |
| **LLM Providers** | Выполнение языковых операций | Claude, GPT-4, Local |

---

### 3. Data Flow Diagram — Основной поток

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ОСНОВНОЙ ПОТОК ОБРАБОТКИ                            │
└─────────────────────────────────────────────────────────────────────────────┘

[USER MESSAGE]
      │
      ▼
┌─────────────┐
│  Interface  │ ──────────────────────────────────────────────────────────┐
│   Layer     │                                                           │
└──────┬──────┘                                                           │
       │                                                                  │
       ▼                                                                  │
┌─────────────────────────────────────────────┐                          │
│           ORCHESTRATOR                       │                          │
│  ┌───────────────────────────────────────┐  │                          │
│  │ 1. Parse Request                      │  │                          │
│  │ 2. Load Digital Profile               │  │                          │
│  │ 3. Classify Request Type              │  │  ◀── DECISION POINT #1  │
│  │    • strategic → Core Agent           │  │      Какой агент?        │
│  │    • analytical → Analyst Agent       │  │                          │
│  │    • operational → Operator Agent     │  │                          │
│  │    • memory → Memory Agent            │  │                          │
│  │ 4. Build Context                      │  │                          │
│  └───────────────────────────────────────┘  │                          │
└──────────────────┬──────────────────────────┘                          │
                   │                                                      │
                   ▼                                                      │
┌─────────────────────────────────────────────┐                          │
│              MEMORY LAYER                    │                          │
│  ┌───────────────────────────────────────┐  │                          │
│  │ 5. Fetch Short-term Context (Redis)   │  │                          │
│  │ 6. Semantic Search (Vector DB)        │  │  ◀── DECISION POINT #2  │
│  │ 7. Retrieve Relevant Long-term Memory │  │      Какой контекст?     │
│  └───────────────────────────────────────┘  │                          │
└──────────────────┬──────────────────────────┘                          │
                   │                                                      │
                   ▼                                                      │
┌─────────────────────────────────────────────┐                          │
│              AGENT LAYER                     │                          │
│  ┌───────────────────────────────────────┐  │                          │
│  │ 8. Agent receives:                    │  │                          │
│  │    • User message                     │  │                          │
│  │    • Digital Profile                  │  │                          │
│  │    • Relevant memory context          │  │                          │
│  │ 9. Agent calls LLM                    │  │                          │
│  │ 10. Agent processes response          │  │  ◀── DECISION POINT #3  │
│  │     • Save to memory?                 │  │      Что сохранить?      │
│  │     • Trigger analysis?               │  │                          │
│  │     • Need different agent?           │  │                          │
│  └───────────────────────────────────────┘  │                          │
└──────────────────┬──────────────────────────┘                          │
                   │                                                      │
                   ├───────────────────────────────────────────┐         │
                   │                                           │         │
                   ▼                                           ▼         │
┌──────────────────────────┐              ┌────────────────────────────┐ │
│      LLM PROVIDER        │              │        MEMORY LAYER        │ │
│  ┌────────────────────┐  │              │  ┌──────────────────────┐  │ │
│  │ 11. Execute prompt │  │              │  │ 12. Save if needed:  │  │ │
│  │     with profile   │  │              │  │     • decision       │  │ │
│  │     constraints    │  │              │  │     • insight        │  │ │
│  └────────────────────┘  │              │  │     • fact           │  │ │
└────────────┬─────────────┘              │  └──────────────────────┘  │ │
             │                            └─────────────┬──────────────┘ │
             │                                          │                │
             ▼                                          ▼                │
┌──────────────────────────┐              ┌────────────────────────────┐ │
│        RESPONSE          │              │    CAL (ASYNC)              │ │
│  ┌────────────────────┐  │              │  ┌──────────────────────┐  │ │
│  │ 13. Format response│  │              │  │ 14. Topic extraction │  │ │
│  │     for user       │  │              │  │ 15. Graph update     │  │ │
│  └────────────────────┘  │              │  │ 16. Anomaly check    │  │ │
└────────────┬─────────────┘              │  └──────────────────────┘  │ │
             │                            └────────────────────────────┘ │
             ▼                                                           │
      [USER SEES RESPONSE] ◀─────────────────────────────────────────────┘
```

---

### 4. Точки принятия решений (Decision Points)

| # | Место | Кто решает | Что решает |
|---|-------|------------|------------|
| 1 | Orchestrator | Request Router | Какой агент обработает запрос |
| 2 | Memory Layer | Context Manager | Какой контекст релевантен |
| 3 | Agent Layer | Agent Logic | Что сохранить в память |
| 4 | CAL | Async Worker | Какие паттерны выявлены |

**Ключевой принцип:** Все решения принимаются **вне LLM**. LLM — исполнитель, а не субъект.

---

### 5. Потоки данных между компонентами

```
┌──────────────────────────────────────────────────────────────────┐
│                      DATA FLOW MATRIX                            │
└──────────────────────────────────────────────────────────────────┘

FROM → TO              │ DATA                    │ SYNC/ASYNC
───────────────────────┼─────────────────────────┼────────────
Interface → Orchestrator│ User message, metadata │ Sync
Orchestrator → Memory   │ Query for context      │ Sync
Memory → Orchestrator   │ Relevant memories      │ Sync
Orchestrator → Agent    │ Full context package   │ Sync
Agent → LLM             │ Prompt + constraints   │ Sync
LLM → Agent             │ Raw response           │ Sync
Agent → Memory          │ Items to save          │ Async
Agent → Interface       │ Formatted response     │ Sync
Memory → CAL            │ New memory items       │ Async (queue)
CAL → Memory            │ Topics, links, scores  │ Async
CAL → UI                │ Analytics data         │ On-demand
```

---

## ✅ Критерии завершения

- [x] Все слои из ADR v1.2 представлены
- [x] Потоки данных явно указаны
- [x] Точки принятия решений (оркестратор) выделены
- [x] Схема понятна без дополнительных объяснений

---

## 📎 Связанные документы

- [ADR v1.2 — Cognitive Analytics Layer](../../ADR%20v1.2%20—%20Cognitive%20Analytics%20Layer.md)
- [README](../../REDME.md)
- [TASK 0.2 — MVP Scope](./TASK_0.2_MVP_Scope.md)
